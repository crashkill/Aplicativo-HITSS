# ============================================
# GitLab CI/CD Pipeline - Sistema HITSS
# Global HITSS - GestÃ£o Financeira + Talentos
# ============================================

# ğŸ¯ ConfiguraÃ§Ã£o Global
stages:
  - ğŸ” validate
  - ğŸ—ï¸ build
  - ğŸ§ª test
  - ğŸš€ deploy
  - ğŸ“Š monitor

# ğŸ“¦ ConfiguraÃ§Ã£o de Cache
cache:
  paths:
    - node_modules/
    - .pnpm-store/
  key:
    files:
      - pnpm-lock.yaml

# ğŸ”§ ConfiguraÃ§Ã£o Base
variables:
  NODE_VERSION: "20"
  PNPM_VERSION: "8.15.0"
  DEBIAN_FRONTEND: noninteractive

# ğŸ“‹ Template Base para Jobs Node.js
.node_template: &node_template
  image: node:${NODE_VERSION}-alpine
  before_script:
    - echo "ğŸ”§ Configurando ambiente Node.js..."
    - npm install -g pnpm@${PNPM_VERSION}
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
    - echo "âœ… Ambiente configurado!"

# ============================================
# STAGE 1: ğŸ” VALIDATE - Qualidade de CÃ³digo
# ============================================

ğŸ” lint:
  <<: *node_template
  stage: ğŸ” validate
  script:
    - echo "ğŸ” Executando linting..."
    - pnpm lint
    - echo "âœ… Linting passou!"
  artifacts:
    reports:
      junit: reports/lint-results.xml
    paths:
      - reports/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

ğŸ” typescript:
  <<: *node_template
  stage: ğŸ” validate
  script:
    - echo "ğŸ” Verificando TypeScript..."
    - pnpm type-check
    - echo "âœ… TypeScript passou!"
  artifacts:
    reports:
      junit: reports/typescript-results.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

ğŸ” security:
  <<: *node_template
  stage: ğŸ” validate
  script:
    - echo "ğŸ”’ Verificando seguranÃ§a..."
    - pnpm audit --audit-level moderate
    - echo "âœ… Auditoria de seguranÃ§a passou!"
  allow_failure: true
  artifacts:
    reports:
      junit: reports/security-results.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# STAGE 2: ğŸ—ï¸ BUILD - ConstruÃ§Ã£o da AplicaÃ§Ã£o
# ============================================

ğŸ—ï¸ build:
  <<: *node_template
  stage: ğŸ—ï¸ build
  script:
    - echo "ğŸ—ï¸ Iniciando build da aplicaÃ§Ã£o..."
    - echo "ğŸ”§ Configurando variÃ¡veis de ambiente..."
    
    # Configurar variÃ¡veis do Doppler (se disponÃ­vel)
    - |
      if command -v doppler >/dev/null 2>&1; then
        echo "ğŸ“¦ Doppler detectado, carregando secrets..."
        doppler run --command="pnpm build" || pnpm build
      else
        echo "âš ï¸ Doppler nÃ£o disponÃ­vel, usando build padrÃ£o..."
        pnpm build
      fi
    
    - echo "âœ… Build concluÃ­do!"
    - echo "ğŸ“Š EstatÃ­sticas do build:"
    - du -sh dist/
    - find dist/ -name "*.js" -o -name "*.css" | wc -l
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
    reports:
      dotenv: build.env
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# STAGE 3: ğŸ§ª TEST - Testes da AplicaÃ§Ã£o
# ============================================

ğŸ§ª unit-tests:
  <<: *node_template
  stage: ğŸ§ª test
  script:
    - echo "ğŸ§ª Executando testes unitÃ¡rios..."
    - pnpm test --coverage --reporter=junit --outputFile=reports/unit-tests.xml
    - echo "âœ… Testes unitÃ¡rios passaram!"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: reports/unit-tests.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

ğŸ§ª integration-tests:
  <<: *node_template
  stage: ğŸ§ª test
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_pass
    POSTGRES_HOST_AUTH_METHOD: trust
  script:
    - echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
    - echo "ğŸ—„ï¸ Configurando banco de testes..."
    - pnpm test:integration --reporter=junit --outputFile=reports/integration-tests.xml
    - echo "âœ… Testes de integraÃ§Ã£o passaram!"
  artifacts:
    reports:
      junit: reports/integration-tests.xml
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ============================================
# STAGE 4: ğŸš€ DEPLOY - Deploy da AplicaÃ§Ã£o
# ============================================

ğŸš€ deploy-staging:
  stage: ğŸš€ deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸš€ Deploy para ambiente de staging..."
    - echo "ğŸ“¦ Preparando artefatos..."
    - echo "ğŸŒ Deploy simulado (configurar com infraestrutura real)"
    - echo "âœ… Deploy de staging concluÃ­do!"
  environment:
    name: staging
    url: https://staging.hitss.com
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  dependencies:
    - ğŸ—ï¸ build

ğŸš€ deploy-production:
  stage: ğŸš€ deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸš€ Deploy para produÃ§Ã£o..."
    - echo "ğŸ“¦ Preparando artefatos de produÃ§Ã£o..."
    - echo "ğŸ”’ Validando seguranÃ§a..."
    - echo "ğŸŒ Deploy de produÃ§Ã£o (configurar com infraestrutura real)"
    - echo "âœ… Deploy de produÃ§Ã£o concluÃ­do!"
  environment:
    name: production
    url: https://hitss.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  dependencies:
    - ğŸ—ï¸ build
    - ğŸ§ª unit-tests

# ============================================
# STAGE 5: ğŸ“Š MONITOR - Monitoramento
# ============================================

ğŸ“Š health-check:
  stage: ğŸ“Š monitor
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸ¥ Executando health check..."
    - echo "ğŸ” Verificando endpoints..."
    - echo "ğŸ“Š Coletando mÃ©tricas..."
    - echo "âœ… Health check concluÃ­do!"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: delayed
      start_in: 5 minutes
  dependencies: []

ğŸ“Š performance-test:
  stage: ğŸ“Š monitor
  image: sitespeedio/sitespeed.io:latest
  script:
    - echo "âš¡ Executando testes de performance..."
    - echo "ğŸ“Š Simulando anÃ¡lise de performance..."
    - echo "âœ… Testes de performance concluÃ­dos!"
  artifacts:
    paths:
      - sitespeed-result/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: delayed
      start_in: 10 minutes
  allow_failure: true

# ============================================
# ğŸ”§ JOBS ESPECIAIS
# ============================================

# Job para limpeza de cache (manual)
ğŸ§¹ clear-cache:
  stage: ğŸ” validate
  script:
    - echo "ğŸ§¹ Limpando cache..."
    - rm -rf node_modules/ .pnpm-store/
    - echo "âœ… Cache limpo!"
  rules:
    - when: manual
  cache: {}

# Job para backup (agenda noturna)
ğŸ’¾ backup:
  stage: ğŸ“Š monitor
  script:
    - echo "ğŸ’¾ Executando backup..."
    - echo "ğŸ“¦ Criando backup dos artefatos..."
    - echo "âœ… Backup concluÃ­do!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  dependencies: []

# ============================================
# ğŸ“§ NOTIFICAÃ‡Ã•ES
# ============================================

# NotificaÃ§Ã£o de sucesso/falha via webhook (configurar)
ğŸ“§ notify:
  stage: ğŸ“Š monitor
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ğŸ“§ Enviando notificaÃ§Ã£o..."
    - |
      if [ "$CI_JOB_STATUS" = "success" ]; then
        echo "âœ… Pipeline executado com sucesso!"
      else
        echo "âŒ Pipeline falhou!"
      fi
  rules:
    - when: always
  dependencies: [] 